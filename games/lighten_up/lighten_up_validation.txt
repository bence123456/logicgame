List(TileBase) tiles = map.getTileList();

for (TileBase tile : tiles) {
    if(tile.isHelper()) {
        int expectedAdjacentBulbsNr = tile.getIntValue(1);
        List(TileBase) neighbourTiles = map.getHorizontalAndVerticalNeighboursForTile(tile);

        int actualAdjacentBulbsNr = 0;
        for (int i=0; i<neighbourTiles.size(); i++) {
            TileBase actualTile = neighbourTiles.get(i);
            List(Item) itemList = actualTile.getItemList();

            if (itemList.contains([S2])) {
                actualAdjacentBulbsNr += 1;
            }
        }

        if (expectedAdjacentBulbsNr != actualAdjacentBulbsNr) {
            return false;
        }
    } else {
        Item colorItem = tile.getItem(0);

        if (!tile.isUnmutableType() && !map.isNull(colorItem) && !colorItem.equals([#ffff00])) {
            return false;
        }
    }
}

List(TileBase) tilesWithBulbs = map.getTilesWithGivenItem([S2]);

for (TileBase bulbTile : tilesWithBulbs) {
    List(TileBase) neighbourTilesForBulbTile = map.getTilesInHorizontalAndVerticalLine(bulbTile, false);

    for (TileBase neighbourTile : neighbourTilesForBulbTile) {
        List(Item) neighbourItemList = neighbourTile.getItemList();
        if (neighbourItemList.contains([S2])) {
            return false;
        }
    }
}

return true;